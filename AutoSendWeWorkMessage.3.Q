[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=122
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=795acc8c-6546-4060-bb6a-6b1bdcb8a9cf
Description=Auto Send QYWX Message.3
Enable=0
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=WeWorkSendForm
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Dim screen_height,screen_width

//处理模式 process_model 1:创建群发送, 2:已有群名称发送,3:发送给单人
Dim process_model
//EXCEL配置文件路径
Dim excel_cfg_file
//EXCEL配置文件的其实读取行，结束读取行，每人发送消息数量
Dim read_line_num, start_read_line, send_msg_num
//企业微信的发送快捷键 1, Enter发送，2 Ctrl+Enter发送
Dim wework_send_shortcuts

Dim group_users, group_name, send_msg, user_name
send_msg = Array("", "", "", "")

Event WeWorkSendForm.button_openexcel.Click
	excel_cfg_file = Plugin.File.SelectFile()
	WeWorkSendForm.input_excel.Text = excel_cfg_file
End Event

Event WeWorkSendForm.button_send.Click
	Dim cfg_error
	excel_cfg_file = WeWorkSendForm.input_excel.Text
    process_model = WeWorkSendForm.combo_model.ListIndex - 1
	send_msg_num = WeWorkSendForm.combo_msgnum.ListIndex - 1
	wework_send_shortcuts = WeWorkSendForm.combo_shortcut.ListIndex - 1
	end_read_line = WeWorkSendForm.input_endline
	start_read_line = WeWorkSendForm.input_startline
    CheckConfig (cfg_error)
	If cfg_error = True Then 
		Goto END_SEND
	Else
		Call ProcessAutoSendByModel()
	End If
	Rem END_SEND
End Event

Event WeWorkSendForm.button_stopscript.Click
	ExitScript
End Event

Event WeWorkSendForm.button_help.Click
	RunApp "www.baidu.com"
End Event

//窗口加载
Event WeWorkSendForm.Load

	screen_width = Plugin.sys.GetScRX()
	screen_height = Plugin.sys.GetScRY() 
	TracePrint "screen width:" & screen_width & ",height:" & screen_height
	
	//如果没有读取配置，用默认配置
	Dim cfg_str
	cfg_str = Plugin.File.ReadINI("EXCEL", "FILE", ".\AutoWeWorkSend.ini")
	If Len(cfg_str) = 0 Then
		excel_cfg_file = "D:\Test002.xlsx"
	End If
	TracePrint "Process excel file :"&excel_cfg_file
	cfg_str = Plugin.File.ReadINI("EXCEL", "MSG_NUM", ".\AutoWeWorkSend.ini")
	If Len(cfg_str) = 0 Then
		send_msg_num = 3
	Else 
		send_msg_num = CInt(cfg_str)
	End If
	cfg_str = Plugin.File.ReadINI("EXCEL", "START_LINE", ".\AutoWeWorkSend.ini")
	If Len(cfg_str) = 0 Then
		start_read_line = 2
	Else 
		start_read_line = CInt(cfg_str)
	End If
	cfg_str = Plugin.File.ReadINI("EXCEL", "END_LINE", ".\AutoWeWorkSend.ini")
	If Len(cfg_str) = 0 Or end_read_line <= 0 Or end_read_line < start_read_line Then
		end_read_line = 2
	Else 
		end_read_line = CInt(cfg_str)
	End If
	TracePrint "Send message number  :"&send_msg_num&" start read line:"&start_read_line&" end read line:"&end_read_line
	cfg_str = Plugin.File.ReadINI("PROCESS", "MODEL", ".\AutoWeWorkSend.ini")
	If Len(cfg_str) = 0 Or  process_model < 1 Or process_model > 2 Then
		process_model = 2
	Else 
		process_model = CInt(cfg_str)
	End If
	TracePrint "Send message number  :"&process_model &" cfg_str"&cfg_str
	cfg_str = Plugin.File.ReadINI("SHORTCUTS", "WEWORK_SEND", ".\AutoWeWorkSend.ini")
	If Len(cfg_str) = 0 Then
		wework_send_shortcuts = 2
	Else 
		wework_send_shortcuts = CInt(cfg_str)
	End If
	TracePrint "Process model  :" & process_model & " wework send shortcuts:" & wework_send_shortcuts
	read_line_num = end_read_line - start_read_line + 1
	
	CheckConfig(cfg_error)

	WeWorkSendForm.input_excel.Text = excel_cfg_file
    WeWorkSendForm.combo_model.ListIndex = process_model - 1
	WeWorkSendForm.combo_msgnum.ListIndex = send_msg_num - 1
	WeWorkSendForm.input_endline = end_read_line
	WeWorkSendForm.input_startline = start_read_line
	WeWorkSendForm.combo_shortcut.ListIndex = wework_send_shortcuts - 1
	WeWorkSendForm.progress_send.Value = 0

End Event

//窗口关闭调用函数
Event WeWorkSendForm.UnLoad
    Call Plugin.File.WriteINI("EXCEL", "FILE", excel_cfg_file, ".\AutoWeWorkSend.ini")
    Call Plugin.File.WriteINI("EXCEL", "MSG_NUM", send_msg_num, ".\AutoWeWorkSend.ini")
    Call Plugin.File.WriteINI("EXCEL", "START_LINE", start_read_line, ".\AutoWeWorkSend.ini")
    Call Plugin.File.WriteINI("EXCEL", "END_LINE", end_read_line, ".\AutoWeWorkSend.ini")
    Call Plugin.File.WriteINI("PROCESS", "MODEL", process_model, ".\AutoWeWorkSend.ini")
    Call Plugin.File.WriteINI("SHORTCUTS", "WEWORK_SEND", wework_send_shortcuts, ".\AutoWeWorkSend.ini")
    MessageBox "脚本已经停止！"
End Event

Function ProcessAutoSendByModel()
	//把企业微信的窗口呼叫到前面
	Call ForegroundWeWorkWnd()
	
	If process_model = 1 Then 
	Call CreateGroupAndSendMsg()
	ElseIf	 process_model = 2 Then
		Call FindGroupAndSendMsg()
	ElseIf	 process_model = 3 Then
		Call FindUserAndSendMsg()
	Else 
		TracePrint "process_model error must equal 1,2,3 :" & process_model
		ExitScript
	End If
End Function

Function ForegroundWeWorkWnd()
	Dim hwnd_qw_main,hwnd_fg
	hwnd_qw_main = Plugin.Window.Find("WeWorkWindow", 0)
	//Call Plugin.Window.Top(hwnd_qw_main, 0)
	//Delay 1000
	Call Plugin.Window.Active(hwnd_qw_main)
	Delay 2500
	hwnd_fg = Plugin.Window.Foreground()
	If hwnd_fg = hwnd_qw_main Then
		TracePrint ("Active QY Weixin OK.")
	Else
		TracePrint ("Active QY Weixin  No OK.")
		MessageBox "无法激活企业微信窗口"
		ExitScript
	End If
	
	Dim rect, rect_array
	rect = Plugin.Window.GetClientRect(hwnd_qw_main)
	rect_array = Split(rect, "|")
	wleft = Clng(rect_array(0)): wtop = Clng(rect_array(1))   
	wright = Clng(rect_array(2)) : wbottom = Clng(rect_array(3))
	TracePrint "Rect  " & wleft & "," & wtop & "," & wright & "," & wbottom
End Function

//检查配置是否OK
Function CheckConfig(cfg_error)
	cfg_error = False
	//对配置进行各种检查
	If send_msg_num > 3 And send_msg_num <= 0 Then 
		TracePrint "send_msg_num(must <3):" & send_msg_num
		MessageBox "一次给一个群发送的消息数量不熟练数量不能过大，1<number<3"
		cfg_error = True
		send_msg_num = 3
	End If
	If read_line_num <= 0 Or start_read_line <= 0 Or end_read_line <= 0 Then 
		TracePrint "read_line_num(must >0):" & read_line_num &" end_read_line" & end_read_line
		MessageBox "一次给一个群发送的消息数量不熟练数量不能过大，1<number<3"
		cfg_error = True
		start_read_line = 2
		end_read_line = 2
	End If
	If process_model < 1 Or process_model > 2 Then 
		TracePrint "process_model( eaqul 1,2):" & process_model
		MessageBox "处理模式必须是( eaqul 1,2):" & process_model
		cfg_error = True
		process_model = 2
	End If
	If wework_send_shortcuts < 1 Or wework_send_shortcuts > 2 Then 
		TracePrint "wework_send_shortcuts( eaqul 1,2):" & wework_send_shortcuts
		MessageBox "发送快捷键配置必须是1 OR 2:" & wework_send_shortcuts
		cfg_error = True
		wework_send_shortcuts = 2
	End If
	read_line_num = end_read_line - start_read_line + 1
End Function

//创建群，然后发送消息
Function CreateGroupAndSendMsg()
	Dim read_num
	read_num = 0
	Call Plugin.Office.OpenXls(excel_cfg_file)
	While read_num < read_line_num
    	
		Call ReadConfigFromExcel(start_read_line + read_num)
    	Call OpenCreateGroupChatWnd()
    	Call CreateGroupChat(group_users)
    	Call RenameGroupChatMainWnd(group_name)
    	Call EnterFindWnd()
    	Call FindGroupChatWnd(group_name)
		Call BatchSendWeWorkMessage()
    	WeWorkSendForm.progress_send.Value = 100 * read_num / read_line_num
    	read_num = read_num + 1
	Wend
	Call Plugin.Office.CloseXls()
End Function

//根据群名称找到群，然后发送消息
Function FindGroupAndSendMsg()
	Dim read_num
	read_num = 0
	Call Plugin.Office.OpenXls(excel_cfg_file)
	While read_num < read_line_num
    	
		Call ReadConfigFromExcel(start_read_line + read_num)
    	Call EnterFindWnd()
    	Call FindGroupChatWnd(group_name)
		Call BatchSendWeWorkMessage()
		WeWorkSendForm.progress_send.Value = 100 * read_num / read_line_num
    	read_num = read_num + 1
	Wend
	Call Plugin.Office.CloseXls()
End Function

Function FindUserAndSendMsg()
	Dim read_num
	read_num = 0
	Call Plugin.Office.OpenXls(excel_cfg_file)
	While read_num < read_line_num
    	
		Call ReadConfigFromExcel(start_read_line + read_num)
    	Call EnterFindWnd()
    	Call FindGroupChatWnd(user_name)
		Call BatchSendWeWorkMessage()
		WeWorkSendForm.progress_send.Value = 100 * read_num / read_line_num
    	read_num = read_num + 1
	Wend
	Call Plugin.Office.CloseXls()
End Function

Function ReadConfigFromExcel(line_num)
	
	Dim msg_read_col
	If process_model = 1 Or process_model = 2 Then
    	group_users = Plugin.Office.ReadXls(1, line_num, 1)
    	group_name = Plugin.Office.ReadXls(1, line_num, 2)
    	
    	If group_users = "" Or group_name = "" Then 
    		TracePrint ("EXCEL have not config.")
			MessageBox "EXCEL 中没有相应的数据"
			ExitScript
		End If
		msg_read_col = 3
    Else 
		user_name = Plugin.Office.ReadXls(1, line_num, 1)
		msg_read_col = 2
    End If	
    
	If send_msg_num = 1 Then 
		send_msg(0) = Plugin.Office.ReadXls(1, line_num, msg_read_col + 0)
	ElseIf send_msg_num = 2 Then 
		send_msg(0) = Plugin.Office.ReadXls(1, line_num + read_num, msg_read_col + 0)
		send_msg(1) = Plugin.Office.ReadXls(1, line_num + read_num, msg_read_col + 1)
	// = 3
	Else 
		send_msg(0) = Plugin.Office.ReadXls(1, line_num, msg_read_col + 0)
		send_msg(1) = Plugin.Office.ReadXls(1, line_num, msg_read_col + 1)
		send_msg(2) = Plugin.Office.ReadXls(1, line_num, msg_read_col + 2)
	End If
End Function

//Ctrl + N 打开创建群聊的窗口
Function OpenCreateGroupChatWnd()
	KeyDown 17, 1
    Delay 100
    KeyPress 78, 1
    Delay 100
    KeyUp 17, 1
    Delay 2000
End Function

//批量发送消息
Function BatchSendWeWorkMessage()
	If send_msg_num = 1 Then 
		Call SendWeWorkMessage(send_msg(0))
	ElseIf send_msg_num = 2 Then 
		Call SendWeWorkMessage(send_msg(0))
		Call SendWeWorkMessage(send_msg(1))
	// = 3
    Else 
		Call SendWeWorkMessage(send_msg(0))
		Call SendWeWorkMessage(send_msg(1))
		Call SendWeWorkMessage(send_msg(2))
	End If
End Function

//Ctrl + Enter Or Enter 发送消息
Function SendWeWorkMessage(one_msg)
    SayString one_msg
    Delay 1500
    //这个地方选择的Ctrl + Enter 发送，其他地方可能
    If wework_send_shortcuts = 1 Then 
    	KeyPress "Enter", 1
    	Delay 1500
    ElseIf wework_send_shortcuts = 2 Then 
		KeyDown 17, 1
    	Delay 30
    	KeyPress "Enter", 1
    	Delay 30
    	KeyUp 17, 1
    	Delay 1500
    End If
End Function

//创建群聊
Function CreateGroupChat(group_users)
	Plugin.Sys.SetCLB(group_users)
 	KeyDown 17, 1
 	 Delay 100
	KeyPress 86, 1
	 Delay 100
	KeyUp 17, 1
	Delay 3500
    KeyPress "Enter", 2
    Delay 1500
End Function

//对群联窗口改名
Function RenameGroupChatMainWnd(group_name)
	TracePrint "RenameGroupChatMainWnd"
	//根据窗口"+"定位
	Dim xy_array,xy,x,y
	xy = Plugin.Color.FindMultiColorEx(wleft,wtop,wright,wtop+90,"000000","0|0|000000,1|0|000000,0|1|000000,1|1|000000,0|2|000000,1|2|000000,0|3|000000,1|3|000000",1,0)
	xy_array = Split(xy, "|")
	x = CInt(xy_array(0)) : y = CInt(xy_array(1))
	TracePrint "Fild xy "&xy&" "& x &"," &y
	//如果没有找到，退出
	If x < 0 Or y < 0 Then 
		TracePrint "Not Fild Group Chat Name Windows "
		ExitScript
	End If
	//进入群名称窗口，
    MoveTo x, y
    Delay 200
    LeftClick 1
    SayString group_name
	Delay 200
	MoveR 150, 0
    LeftClick 1
    Delay 200
End Function

//对群联窗口改名
Function RenameGroupChatWnd(group_name)
    hwnd_qw_c = Plugin.Window.Find("WwStandaloneConversationWnd", 0)
    Call Plugin.Bkgnd.LeftClick(hwnd_qw_c, 30, 40)
	Delay 500
    SayString group_name
   Delay 1500
End Function

//Ctrl+O 
Function OpenGroupChatWnd()
	TracePrint "Ctrl+O OpenGroupChatWnd"
	KeyDown 17, 1
    Delay 30
    KeyPress 79, 1
    Delay 30
    KeyUp 17, 1
    Delay 1000
End Function

//Esc
Function CloseGroupChatWnd()
	KeyPress "Esc", 1
    TracePrint "Esc CloseGroupChatWnd"
    Delay 1000
End Function

Function  EnterFindWnd()
    KeyPress 18,1
    Delay 30
    KeyPress 18,1
    Delay 30
    TracePrint "Alt + Alt EnterFindWnd"
    Delay 500
End Function

Function FindGroupChatWnd(find_name)
	TracePrint "FindGroupChatWnd "
	//全选所有的内容，（删除原来的内容）
    KeyDown 17, 1
    Delay 30
	KeyPress 65, 1
	Delay 30
	KeyUp 17, 1
	Delay 500
	SayString find_name
	Delay 1500
    //如果认为那个放大镜非常靠近，则是没有找到
    Dim xy_array,xy,x,y
	xy =Plugin.Color.FindMultiColorEx(wleft,wtop,wleft+300,wtop+160,"56B059","0|0|56B059,1|0|56B059,2|0|56B059,0|1|56B059,1|1|56B059,2|1|56B059,0|2|56B059,1|2|56B059,2|2|56B059,3|2|56B059,3|2|56B059,3|2|56B059",0.9,0)
	xy_array = Split(xy, "|")
	x = CInt(xy_array(0)) : y = CInt(xy_array(1))
	TracePrint "Fild xy " & xy &","& x &"," &y
	//如果找到绿色放大镜子，表示搜索内容其实没有找到（这有点扰），退出
	If x > 0 Or y > 0 Then 
		TracePrint "FindGroupChatWnd Not find group :["&find_name&"] to send message"
		ExitScript
	End If
	KeyPress "Enter", 1
	Delay 500	
End Function

// 脚本结束时提示，同事也处理一些异常终止情况。
Sub OnScriptExit()
    KeyUp 17, 1
    Call Plugin.Office.CloseXls()
End Sub



